<%- include('partials/head.ejs') %>
<%- include('partials/navbar.ejs') %>

<% if (isLoggedIn === false) { %>
  <meta http-equiv="refresh" content="0; URL=/users/login"/>
<% } %>

  <main class="container">

    <h1>Personajes</h1>
      
    <label for="buscar">Buscar</label>
    <input type="hidden" id="_csrf" name="_csrf" value="<%= csrfToken %>">
    <input type="text" name="buscar" id="buscar" onkeyup="buscar()">
    
    <div class=row>
      
      <% for (let personaje of lista_personajes) { %>
        <div class="col s12 m4 l3">
          <div class="card small">
              <div class="card-image waves-effect waves-block waves-light">
                <img class="activator" src="<%= personaje.imagen %>">
              </div>
              <div class="card-content">
                <span class="card-title activator grey-text text-darken-4"><%= personaje.nombre %><i class="material-icons right">more_vert</i></span>
                <p><a href="#">...</a></p>
              </div>
              <div class="card-reveal">
                <span class="card-title grey-text text-darken-4"><%= personaje.nombre %><i class="material-icons right">close</i></span>
                <p>Fuente de la imagen: <%= personaje.imagen %></p>
              </div>
          </div>
        </div>
      <% } %>

    </div>

    <% if (isLoggedIn === true) { %>
      <a href="/personajes/nuevo-personaje" class="waves-effect waves-light btn red"><i class="material-icons left">add</i>Añadir personaje</a>
    <% } %>

    <p></p>

    <a href="/" class="waves-effect waves-light btn green"><i class="material-icons left">arrow_back</i>Volver</a>
    <p></p>

  </main>

<%- include('partials/footer.ejs') %>

<script>
  function buscar() {
    const valor_busqueda = document.getElementById('buscar').value;
    //El token de protección CSRF
    const csrf = document.getElementById('_csrf').value;

    //función que manda la petición asíncrona
    fetch('/personajes/buscar', {
        method: 'POST',
        headers: {
            'csrf-token': csrf
          },
        body: JSON.stringify(valor_busqueda)
    }).then(result => {
        return result.json(); //Regresa otra promesa
    }).then(data => {
        //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
        console.log(data);
    }).catch(err => {
        console.error(err);
    });
  }
</script>